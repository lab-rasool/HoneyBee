---
import BaseLayout from "./BaseLayout.astro";

import "../styles/code.css";

export interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;

const sidebarItems = [
  { text: "Getting Started", href: "/HoneyBee/docs/getting-started" },
  { text: "Clinical Processing", href: "/HoneyBee/docs/clinical-processing" },
  { text: "Pathology Processing", href: "/HoneyBee/docs/pathology-processing" },
  { text: "Radiology Processing", href: "/HoneyBee/docs/radiology-processing" },
  { text: "Molecular Processing", href: "/HoneyBee/docs/molecular-processing" },
];

// Get current path to highlight active item
const currentPath = Astro.url.pathname;
---

<BaseLayout title={title} description={description}>
  <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="lg:grid lg:grid-cols-[240px_1fr] xl:grid-cols-[240px_1fr_220px] lg:gap-8">
      <!-- Sidebar -->
      <div class="hidden lg:block">
        <nav class="sticky top-8 space-y-1">
          <a
            href="/HoneyBee/docs/"
            class="block text-xl font-bold mb-4 text-primary">Documentation</a
          >
          {
            sidebarItems.map((item) => (
              <a
                href={item.href}
                class={`block px-3 py-2 rounded-md text-base font-medium ${
                  currentPath === item.href
                    ? "bg-primary text-white"
                    : "text-gray-700 hover:bg-gray-100"
                }`}
              >
                {item.text}
              </a>
            ))
          }
        </nav>
      </div>

      <!-- Content -->
      <div class="min-w-0">
        <div class="docs-content prose max-w-none">
          <slot />
        </div>
      </div>

      <!-- Table of Contents (right side, xl+ only) -->
      <aside class="hidden xl:block">
        <nav id="toc-nav" class="sticky top-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
          <span class="text-sm font-semibold text-gray-900 block mb-3">On this page</span>
          <ul id="toc-list" class="space-y-1 border-l border-gray-200"></ul>
        </nav>
      </aside>
    </div>
  </div>
</BaseLayout>

<!-- Table of Contents script -->
<script is:inline>
  (function () {
    const content = document.querySelector('.docs-content');
    const tocList = document.getElementById('toc-list');
    if (!content || !tocList) return;

    const headings = content.querySelectorAll('h2, h3');
    if (headings.length === 0) return;

    // Generate slug from text
    function slugify(text) {
      return text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').trim();
    }

    // Build TOC entries and assign IDs
    headings.forEach(function (heading) {
      if (!heading.id) {
        heading.id = slugify(heading.textContent);
      }
      var li = document.createElement('li');
      var a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'block py-1 text-sm text-gray-500 hover:text-amber-600 transition-colors border-l-2 border-transparent -ml-px';
      if (heading.tagName === 'H3') {
        a.classList.add('pl-6');
      } else {
        a.classList.add('pl-3');
      }
      a.addEventListener('click', function (e) {
        e.preventDefault();
        document.getElementById(heading.id).scrollIntoView({ behavior: 'smooth' });
        history.replaceState(null, '', '#' + heading.id);
      });
      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Scroll-spy via IntersectionObserver
    var tocLinks = tocList.querySelectorAll('a');
    var observer = new IntersectionObserver(function (entries) {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          tocLinks.forEach(function (link) {
            if (link.getAttribute('href') === '#' + entry.target.id) {
              link.classList.remove('text-gray-500', 'border-transparent');
              link.classList.add('text-amber-600', 'font-medium', 'border-amber-500');
            } else {
              link.classList.remove('text-amber-600', 'font-medium', 'border-amber-500');
              link.classList.add('text-gray-500', 'border-transparent');
            }
          });
        }
      });
    }, { rootMargin: '0px 0px -80% 0px', threshold: 0 });

    headings.forEach(function (heading) {
      observer.observe(heading);
    });
  })();
</script>

<!-- Add Prism.js for syntax highlighting before closing body -->
<script
  is:inline
  src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"
></script>
<script
  is:inline
  src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"
></script>
